# 项目文档：Magic Brush AI (魔法画笔)

该项目是一款创新的移动端H5应用，它允许用户通过手机摄像头捕捉手势，在空中进行绘画。应用会追踪指尖的运动轨迹生成线稿，然后利用Google Gemini的多模态和图像生成模型，结合用户的创意提示词，将线稿转化为风格独特的艺术作品。

---

## 一、 功能模块说明

根据项目代码结构，应用主要包含以下核心功能模块：

### 1. 欢迎与授权模块 (`WelcomeScreen`)
*   **功能描述**: 这是应用的入口页面。它通过一个美观、友好的界面欢迎用户，并清晰地解释了应用需要摄像头权限的原因——即为了追踪指尖以实现空中绘画。
*   **核心实现**:
    *   展示应用的品牌和核心价值。
    *   包含一个醒目的“授权摄像头”按钮。
    *   调用 `navigator.mediaDevices.getUserMedia` API 来请求摄像头访问权限。
    *   成功获取权限后，将用户导航至绘画界面；如果失败，则通过全局的 `Toast` 组件提示用户授权失败。

### 2. 实时绘画模块 (`DrawingScreen`)
*   **功能描述**: 这是应用的核心交互界面，用户在此创作他们的初始线稿。它提供了两种创新的绘画模式。
*   **核心实现**:
    *   **手势绘画模式**:
        *   利用 `@mediapipe/tasks-vision` 的 `HandLandmarker` 模型实时追踪视频流中的手部关键点。
        *   通过计算拇指尖和食指尖的距离来识别“捏合”手势 (`isPinching`)。
        *   当用户做出捏合手势并移动时，应用会在画布 (`canvas`) 上绘制平滑的线条。
        *   在反馈画布 (`feedbackCanvas`) 上实时显示指尖位置和捏合状态，为用户提供直观的操作反馈。
        *   支持前后摄像头切换，并能正确处理前置摄像头下的镜像反转问题。
    *   **触屏绘画模式**:
        *   作为手势模式的补充和备用方案，允许用户直接在屏幕上通过触摸或鼠标进行绘画。
        *   通过监听 `mousedown`, `mousemove`, `touchstart` 等事件实现。
    *   **辅助功能**:
        *   **颜色选择器 (`ColorPicker`)**: 提供一个预设的调色板和一个自定义颜色选择器，让用户可以改变画笔颜色。
        *   **清除画布**: 一键清空当前绘制的所有内容。
        *   **完成绘画**: 将当前画布内容保存为Base64格式的PNG图片，并跳转到配置页面。

### 3. AI配置模块 (`ConfigScreen`)
*   **功能描述**: 用户完成线稿后，在此页面进行创作的最后配置，为AI生成图像提供指导。
*   **核心实现**:
    *   **线稿预览**: 展示用户从绘画页带来的线稿图像。
    *   **风格选择**: 提供一系列预设的艺术风格选项（如日漫、3D卡通、蒸汽朋克等），用户可以单选其一。
    *   **提示词输入**: 一个文本区域，允许用户输入描述画面内容的创意提示词 (Prompt)。
    *   **灵感获取 (`handleGetInspiration`)**: 这是一个AI辅助功能。
        *   如果提示词为空，它会调用 `getInspirationFromImage` 服务，使用Gemini Vision模型分析线稿内容，并结合DeepSeek模型生成一段描述性的中文提示词。
        *   如果提示词不为空，它会调用 `optimizePromptWithText` 服务，使用DeepSeek模型对现有提示词进行优化和扩展，使其更具想象力。
    *   **重置功能**: 清空已选的风格和已输入的提示词。

### 4. AI代理生成模块 (`geminiService.ts`)
*   **功能描述**: 这是驱动图像生成的核心逻辑，它封装了与AI模型的全部交互。该模块设计了两种不同的工作流（Agent），以满足不同的用户需求。
*   **核心实现**:
    *   **绘画助手代理 (`runDrawingAssistantAgent`)**:
        *   **工作流**: 接收用户的线稿、提示词和风格。
        *   **Prompt Engineering**: 它会首先将中文提示词和风格翻译成英文（因为模型对英文的理解通常更佳），然后构建一个结构化的Prompt，**强调**AI必须以用户提供的线稿作为“严格的结构参考”，以确保生成结果在构图上与用户原作高度相似。
        *   **API调用**: 调用 `gemini-2.5-flash-image` 模型，同时传入线稿图片和结构化后的文本Prompt，生成最终图像。
    *   **AI猜画代理 (`runAiGuessAgent`)**:
        *   **工作流**: 仅接收用户的线稿，无需用户输入提示词。
        *   **自主创作**: 它首先使用Gemini Vision模型分析线稿的主题，然后让DeepSeek模型基于该主题创作一段富有想象力的描述，最后将这段描述翻译成英文，并调用图像生成模型进行创作。这相当于让AI根据用户的画作进行一次“看图说话”式的创作。
    *   **服务集成**:
        *   **多模型协同**: 巧妙地结合了 `gemini-2.5-pro` (用于视觉分析和翻译) 、`gemini-2.5-flash-image` (用于图像生成) 和 `DeepSeek-Chat` (用于中文创意文本生成) 的优势。
        *   **加载体验优化**: `getFunnyJokeOrQuote` 服务会在生成图像的等待期间，从AI获取一个简短的笑话或名言，显示在加载界面上，提升用户等待体验。

### 5. 作品预览与操作模块 (`PreviewScreen`)
*   **功能描述**: 展示AI生成的最终艺术作品，并提供后续操作。
*   **核心实现**:
    *   **作品展示**: 在页面中央以卡片形式展示生成的图片。
    *   **信息展示**: 显示本次创作所选的风格和渲染所花费的时间。
    *   **重新渲染**: 允许用户基于完全相同的配置（线稿、提示词、风格）再次调用AI生成，以获得不同的创作结果。
    *   **下载图片**: 将生成的图片保存到用户的本地设备。
    *   **返回修改**: 用户可以返回到配置页面，调整风格或提示词后再次生成。

### 6. 全局状态与UI模块 (`AppContext`, `LoadingOverlay`, `Toast`)
*   **功能描述**: 负责管理整个应用的全局状态和提供统一的用户反馈。
*   **核心实现**:
    *   **状态管理 (`AppContext`)**: 使用React Context API来管理应用的屏幕切换、线稿数据、配置项、生成结果、加载状态和错误信息，实现了跨组件的数据共享。
    *   **加载动画 (`LoadingOverlay`)**: 一个全局的加载遮罩层，在进行AI计算（如获取灵感、生成图像）时显示，阻止用户操作并提供友好的等待提示。
    *   **消息提示 (`Toast`)**: 一个全局的轻量级提示组件，用于显示错误信息或重要的成功提示，并在几秒后自动消失。

---

## 二、 完整使用流程说明

一位新用户使用“魔法画笔”AI应用的完整旅程如下：

1.  **第一步：进入应用与授权**
    *   用户打开应用，看到一个充满创意的欢迎页面。
    *   点击“**授权摄像头**”按钮，浏览器会弹出请求摄像头权限的对话框。
    *   用户选择“**允许**”。

2.  **第二步：空中绘画创作**
    *   应用自动跳转到绘画界面，摄像头开启，用户可以在屏幕上看到自己的实时影像。
    *   **手势绘画**: 用户伸出食指和拇指，做出“**捏合**”手势，此时屏幕上会出现一个光点。保持捏合，在空中移动手指，即可看到一条彩色线条跟随着指尖的轨迹被绘制出来。松开手指，则停止绘画。
    *   **模式切换**: 如果用户觉得手势操作不便，可以点击 `draw` 图标切换到“**触屏模式**”，直接在屏幕上绘画。
    *   **自定义**: 用户可以点击 `palette` 图标打开调色板，选择喜欢的颜色进行绘画。如果画错了，可以点击 `delete` 图标清空画布重画。
    *   **完成**: 对自己的线稿满意后，用户点击 `check` (完成)按钮。

3.  **第三步：配置AI创作参数**
    *   应用跳转到配置页面，页面顶部会显示刚刚完成的线稿。
    *   用户在下方的风格区选择一个喜欢的艺术风格，例如“**日漫**”。
    *   在文本框中输入自己的创意，例如“一个在月球上喝茶的宇航员”。
    *   **(可选) 获取灵感**: 如果用户没有想法，可以留空提示词，然后点击 `auto_awesome` (灵感)按钮，AI会分析线稿并自动生成一句提示词。如果用户已经输入了提示词，点击此按钮，AI会对现有文字进行润色和优化。

4.  **第四步：启动AI生成**
    *   用户有两个选择：
        *   **选择A (常规生成)**: 点击“**开始绘制 ✨**”按钮。应用会启动“绘画助手代理”，结合用户的线稿、选择的“日漫”风格和输入的“宇航员”提示词进行创作。
        *   **选择B (AI猜画)**: 如果用户没有输入任何提示词，可以点击“**AI猜猜 🤔**”按钮。应用会启动“AI猜画代理”，完全由AI来解读线稿并自由发挥创作。
    *   点击按钮后，屏幕上会出现一个加载动画，并显示一句有趣的笑话或名言，让等待过程不那么枯燥。

5.  **第五步：预览、下载或再创作**
    *   几秒钟后，AI创作完成，页面跳转到预览页。
    *   用户会看到一张融合了自己线稿结构、日漫风格和宇航员主题的精美图片。
    *   在图片下方，用户可以看到本次生成所用的风格和耗时。
    *   用户此时可以：
        *   点击“**📥下载图片**”按钮，将作品保存到手机。
        *   点击“**重新渲染**”按钮，让AI用同样的参数再画一张，可能会有惊喜。
        *   点击左上角的“**返回**”按钮，回到配置页，修改提示词或风格后进行新的创作。

通过以上流程，用户可以体验到一个从亲手绘制到AI赋能的完整、流畅且充满乐趣的艺术创作过程。
